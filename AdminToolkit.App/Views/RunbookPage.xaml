<Page x:Class="AdminToolkit.App.Views.RunbookPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Title="Runbook">

    <Grid Margin="32,24,32,32">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <DockPanel Grid.Row="0" Margin="0,0,0,16">
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right">
                <ui:Button Content="Reload Scripts" Command="{Binding LoadScriptsCommand}" Margin="0,0,8,0" />
                <ui:Button Content="Export History" Command="{Binding ExportHistoryCommand}" />
            </StackPanel>
            <TextBlock Text="Script Runbook" FontSize="28" FontWeight="SemiBold" VerticalAlignment="Center" />
        </DockPanel>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="320" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- Left: Script List + Params -->
            <DockPanel Grid.Column="0" Margin="0,0,16,0">

                <!-- Script List -->
                <Border DockPanel.Dock="Top" Background="{DynamicResource ControlFillColorDefaultBrush}"
                        CornerRadius="8" Padding="16" Margin="0,0,0,12">
                    <DockPanel>
                        <TextBlock DockPanel.Dock="Top" Text="Scripts" FontWeight="SemiBold" FontSize="14" Margin="0,0,0,8" />
                        <ListBox ItemsSource="{Binding Scripts}"
                                 SelectedItem="{Binding SelectedScript, Mode=TwoWay}"
                                 MaxHeight="200"
                                 DisplayMemberPath="Name" />
                    </DockPanel>
                </Border>

                <!-- Script Details -->
                <Border Background="{DynamicResource ControlFillColorDefaultBrush}"
                        CornerRadius="8" Padding="16"
                        Visibility="{Binding SelectedScript, Converter={StaticResource NullToVisibility}}">
                    <DockPanel>
                        <TextBlock DockPanel.Dock="Top" Text="{Binding SelectedScript.Name}"
                                   FontWeight="SemiBold" FontSize="14" Margin="0,0,0,4" />
                        <TextBlock DockPanel.Dock="Top" Text="{Binding SelectedScript.Description}"
                                   Opacity="0.6" TextWrapping="Wrap" Margin="0,0,0,16" />

                        <TextBlock DockPanel.Dock="Top" Text="Parameters" FontWeight="SemiBold"
                                   FontSize="13" Margin="0,0,0,8" />

                        <ScrollViewer DockPanel.Dock="Top" VerticalScrollBarVisibility="Auto" MaxHeight="300">
                            <ItemsControl ItemsSource="{Binding ParameterEntries}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Margin="0,0,0,10">
                                            <TextBlock FontSize="12" Margin="0,0,0,4">
                                                <Run Text="{Binding DisplayName}" FontWeight="SemiBold" />
                                                <Run Text="{Binding Required, StringFormat=' (required: {0})'}" Foreground="Gray" />
                                            </TextBlock>
                                            <TextBlock Text="{Binding Description}" Opacity="0.5" FontSize="11"
                                                       Margin="0,0,0,4" TextWrapping="Wrap"
                                                       Visibility="{Binding Description, Converter={StaticResource NullToVisibility}}" />
                                            <ui:TextBox Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                                        PlaceholderText="{Binding DisplayName}" />
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>

                        <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" Margin="0,12,0,0">
                            <ui:Button Content="Run Script" Appearance="Primary"
                                       Command="{Binding RunScriptCommand}" Margin="0,0,8,0"
                                       Visibility="{Binding IsRunning, Converter={StaticResource InverseBoolToVisibility}}" />
                            <ui:Button Content="Cancel" Appearance="Danger"
                                       Command="{Binding CancelScriptCommand}"
                                       Visibility="{Binding IsRunning, Converter={StaticResource BoolToVisibility}}" />
                        </StackPanel>
                    </DockPanel>
                </Border>
            </DockPanel>

            <!-- Right: Output + History -->
            <DockPanel Grid.Column="1">

                <!-- Output -->
                <Border DockPanel.Dock="Top" Background="{DynamicResource ControlFillColorDefaultBrush}"
                        CornerRadius="8" Padding="16" Margin="0,0,0,12">
                    <DockPanel>
                        <DockPanel DockPanel.Dock="Top" Margin="0,0,0,8">
                            <ui:Button DockPanel.Dock="Right" Content="Copy" Appearance="Transparent"
                                       Command="{Binding CopyOutputCommand}" />
                            <TextBlock Text="Output" FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center" />
                        </DockPanel>
                        <ProgressBar DockPanel.Dock="Top" IsIndeterminate="True" Margin="0,0,0,8"
                                     Visibility="{Binding IsRunning, Converter={StaticResource BoolToVisibility}}" />
                        <TextBox Text="{Binding OutputLog, Mode=OneWay}"
                                 IsReadOnly="True"
                                 VerticalScrollBarVisibility="Auto"
                                 HorizontalScrollBarVisibility="Auto"
                                 FontFamily="Cascadia Code,Consolas,Courier New"
                                 FontSize="12"
                                 MaxHeight="350"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 TextWrapping="NoWrap" />
                    </DockPanel>
                </Border>

                <!-- History -->
                <Border Background="{DynamicResource ControlFillColorDefaultBrush}"
                        CornerRadius="8" Padding="16">
                    <DockPanel>
                        <TextBlock DockPanel.Dock="Top" Text="Execution History" FontWeight="SemiBold"
                                   FontSize="14" Margin="0,0,0,8" />
                        <DataGrid ItemsSource="{Binding History}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  CanUserSortColumns="True"
                                  GridLinesVisibility="Horizontal"
                                  RowHeaderWidth="0"
                                  MaxHeight="250">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Script" Binding="{Binding ScriptName}" Width="*" />
                                <DataGridTextColumn Header="Started" Binding="{Binding StartedAt, StringFormat=g}" Width="140" />
                                <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="90" />
                            </DataGrid.Columns>
                        </DataGrid>
                    </DockPanel>
                </Border>
            </DockPanel>
        </Grid>
    </Grid>
</Page>
