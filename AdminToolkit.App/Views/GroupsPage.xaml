<Page x:Class="AdminToolkit.App.Views.GroupsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Title="Groups">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <DockPanel Grid.Column="0" Margin="32,24,16,32">

            <DockPanel DockPanel.Dock="Top" Margin="0,0,0,16">
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" HorizontalAlignment="Right">
                    <ui:Button Content="Create Group" Appearance="Primary"
                               Command="{Binding ToggleCreatePanelCommand}" Margin="0,0,8,0" />
                    <ui:Button Content="Refresh" Command="{Binding LoadGroupsCommand}" />
                </StackPanel>
                <TextBlock Text="Groups" FontSize="28" FontWeight="SemiBold" VerticalAlignment="Center" />
            </DockPanel>

            <Grid DockPanel.Dock="Top" Margin="0,0,0,12">
                <ui:TextBox PlaceholderText="Search groups..."
                            Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}">
                    <ui:TextBox.InputBindings>
                        <KeyBinding Key="Return" Command="{Binding LoadGroupsCommand}" />
                    </ui:TextBox.InputBindings>
                </ui:TextBox>
            </Grid>

            <!-- Create Panel -->
            <Border DockPanel.Dock="Top" Background="{DynamicResource ControlFillColorDefaultBrush}"
                    CornerRadius="8" Padding="20" Margin="0,0,0,12"
                    Visibility="{Binding IsCreatePanelOpen, Converter={StaticResource BoolToVisibility}}">
                <StackPanel>
                    <TextBlock Text="Create New Group" FontWeight="SemiBold" FontSize="14" Margin="0,0,0,12" />
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <ui:TextBox Grid.Column="0" PlaceholderText="Group Name"
                                    Text="{Binding NewGroupName}" Margin="0,0,8,0" />
                        <ui:TextBox Grid.Column="1" PlaceholderText="Description"
                                    Text="{Binding NewGroupDescription}" Margin="0,0,8,0" />
                        <ui:Button Grid.Column="2" Content="Create" Appearance="Primary"
                                   Command="{Binding CreateGroupCommand}" MinWidth="80" />
                    </Grid>
                </StackPanel>
            </Border>

            <ProgressBar DockPanel.Dock="Top" IsIndeterminate="True" Margin="0,0,0,8"
                         Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}" />

            <DataGrid ItemsSource="{Binding Groups}"
                      SelectedItem="{Binding SelectedGroup, Mode=TwoWay}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True" SelectionMode="Single"
                      CanUserSortColumns="True"
                      GridLinesVisibility="Horizontal"
                      RowHeaderWidth="0">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Display Name" Binding="{Binding DisplayName}" Width="*" />
                    <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="*" />
                    <DataGridTextColumn Header="Type" Binding="{Binding GroupType}" Width="100" />
                    <DataGridTextColumn Header="Mail" Binding="{Binding Mail}" Width="160" />
                </DataGrid.Columns>
            </DataGrid>
        </DockPanel>

        <!-- Detail Drawer -->
        <Border Grid.Column="1" Width="360"
                Background="{DynamicResource ControlFillColorDefaultBrush}"
                CornerRadius="8,0,0,8" Padding="24"
                Visibility="{Binding IsDetailOpen, Converter={StaticResource BoolToVisibility}}">
            <DockPanel>
                <DockPanel DockPanel.Dock="Top" Margin="0,0,0,16">
                    <ui:Button DockPanel.Dock="Right" Appearance="Transparent" Content="X"
                               Command="{Binding CloseDetailCommand}" />
                    <TextBlock Text="{Binding SelectedGroup.DisplayName}" FontWeight="SemiBold" FontSize="16" VerticalAlignment="Center" />
                </DockPanel>

                <StackPanel DockPanel.Dock="Top">
                    <TextBlock Text="{Binding SelectedGroup.Description}" Opacity="0.6" Margin="0,0,0,16" TextWrapping="Wrap" />

                    <TextBlock Text="Members" FontWeight="SemiBold" Margin="0,0,0,8" />

                    <!-- Add member -->
                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <ui:TextBox Grid.Column="0" PlaceholderText="User UPN"
                                    Text="{Binding AddMemberUpn}" Margin="0,0,8,0" />
                        <ui:Button Grid.Column="1" Content="Add" Appearance="Primary"
                                   Command="{Binding AddMemberCommand}" />
                    </Grid>

                    <ListView ItemsSource="{Binding GroupMembers}" MaxHeight="400">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <DockPanel>
                                    <ui:Button DockPanel.Dock="Right" Content="Remove" Appearance="Danger"
                                               FontSize="11" Padding="8,4"
                                               Command="{Binding DataContext.RemoveMemberCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                               CommandParameter="{Binding}" />
                                    <StackPanel>
                                        <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" />
                                        <TextBlock Text="{Binding UserPrincipalName}" Opacity="0.5" FontSize="12" />
                                    </StackPanel>
                                </DockPanel>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </StackPanel>
            </DockPanel>
        </Border>
    </Grid>
</Page>
