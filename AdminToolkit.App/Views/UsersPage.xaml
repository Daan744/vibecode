<Page x:Class="AdminToolkit.App.Views.UsersPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Title="Users">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <!-- Main Content -->
        <DockPanel Grid.Column="0" Margin="32,24,16,32">

            <!-- Header -->
            <DockPanel DockPanel.Dock="Top" Margin="0,0,0,16">
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" HorizontalAlignment="Right">
                    <ui:Button Content="Create User" Appearance="Primary"
                               Command="{Binding ToggleCreatePanelCommand}" Margin="0,0,8,0" />
                    <ui:Button Content="Refresh" Command="{Binding LoadUsersCommand}" />
                </StackPanel>
                <TextBlock Text="Users" FontSize="28" FontWeight="SemiBold" VerticalAlignment="Center" />
            </DockPanel>

            <!-- Search -->
            <Grid DockPanel.Dock="Top" Margin="0,0,0,12">
                <ui:TextBox PlaceholderText="Search by display name..."
                            Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}">
                    <ui:TextBox.InputBindings>
                        <KeyBinding Key="Return" Command="{Binding LoadUsersCommand}" />
                    </ui:TextBox.InputBindings>
                </ui:TextBox>
            </Grid>

            <!-- Create Panel -->
            <Border DockPanel.Dock="Top" Background="{DynamicResource ControlFillColorDefaultBrush}"
                    CornerRadius="8" Padding="20" Margin="0,0,0,12"
                    Visibility="{Binding IsCreatePanelOpen, Converter={StaticResource BoolToVisibility}}">
                <StackPanel>
                    <TextBlock Text="Create New User" FontWeight="SemiBold" FontSize="14" Margin="0,0,0,12" />
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <ui:TextBox Grid.Column="0" PlaceholderText="Display Name"
                                    Text="{Binding NewDisplayName}" Margin="0,0,8,0" />
                        <ui:TextBox Grid.Column="1" PlaceholderText="user@domain.com"
                                    Text="{Binding NewUpn}" Margin="0,0,8,0" />
                        <ui:TextBox Grid.Column="2" PlaceholderText="Password"
                                    Text="{Binding NewPassword}" Margin="0,0,8,0" />
                        <ui:Button Grid.Column="3" Content="Create" Appearance="Primary"
                                   Command="{Binding CreateUserCommand}" MinWidth="80" />
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Loading -->
            <ProgressBar DockPanel.Dock="Top" IsIndeterminate="True" Margin="0,0,0,8"
                         Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}" />

            <!-- DataGrid -->
            <DataGrid ItemsSource="{Binding Users}"
                      SelectedItem="{Binding SelectedUser, Mode=TwoWay}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      SelectionMode="Single"
                      CanUserSortColumns="True"
                      GridLinesVisibility="Horizontal"
                      BorderThickness="1"
                      RowHeaderWidth="0">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Display Name" Binding="{Binding DisplayName}" Width="*" />
                    <DataGridTextColumn Header="UPN" Binding="{Binding UserPrincipalName}" Width="*" />
                    <DataGridTextColumn Header="Department" Binding="{Binding Department}" Width="120" />
                    <DataGridTextColumn Header="Job Title" Binding="{Binding JobTitle}" Width="120" />
                    <DataGridTextColumn Header="Status" Binding="{Binding StatusDisplay}" Width="80" />
                </DataGrid.Columns>
            </DataGrid>
        </DockPanel>

        <!-- Detail Drawer -->
        <Border Grid.Column="1" Width="340"
                Background="{DynamicResource ControlFillColorDefaultBrush}"
                CornerRadius="8,0,0,8" Padding="24"
                Visibility="{Binding IsDetailOpen, Converter={StaticResource BoolToVisibility}}">
            <DockPanel>
                <DockPanel DockPanel.Dock="Top" Margin="0,0,0,20">
                    <ui:Button DockPanel.Dock="Right" Appearance="Transparent" Content="X"
                               Command="{Binding CloseDetailCommand}" />
                    <TextBlock Text="User Details" FontWeight="SemiBold" FontSize="16" VerticalAlignment="Center" />
                </DockPanel>

                <StackPanel>
                    <TextBlock Text="Display Name" Opacity="0.5" FontSize="12" />
                    <TextBlock Text="{Binding SelectedUser.DisplayName}" FontSize="14" Margin="0,2,0,12" />

                    <TextBlock Text="UPN" Opacity="0.5" FontSize="12" />
                    <TextBlock Text="{Binding SelectedUser.UserPrincipalName}" FontSize="14" Margin="0,2,0,12" />

                    <TextBlock Text="Email" Opacity="0.5" FontSize="12" />
                    <TextBlock Text="{Binding SelectedUser.Mail}" FontSize="14" Margin="0,2,0,12" />

                    <TextBlock Text="Department" Opacity="0.5" FontSize="12" />
                    <TextBlock Text="{Binding SelectedUser.Department}" FontSize="14" Margin="0,2,0,12" />

                    <TextBlock Text="Status" Opacity="0.5" FontSize="12" />
                    <TextBlock Text="{Binding SelectedUser.StatusDisplay}" FontSize="14" Margin="0,2,0,20" />

                    <!-- Actions -->
                    <ui:Button Content="{Binding SelectedUser.AccountEnabled, FallbackValue='Toggle Block'}"
                               Appearance="Caution"
                               Command="{Binding ToggleBlockUserCommand}"
                               Margin="0,0,0,8" HorizontalAlignment="Stretch" />

                    <TextBlock Text="Reset Password" FontWeight="SemiBold" Margin="0,12,0,8" />
                    <ui:TextBox PlaceholderText="New password"
                                Text="{Binding ResetPasswordValue}" Margin="0,0,0,8" />
                    <ui:Button Content="Reset Password" Appearance="Danger"
                               Command="{Binding ResetPasswordCommand}" HorizontalAlignment="Stretch" />
                </StackPanel>
            </DockPanel>
        </Border>
    </Grid>
</Page>
